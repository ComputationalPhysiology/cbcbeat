# A Simplified Ventricular Myocyte Model
# 
# ABSTRACT: Wave propagation in ventricular muscle is rendered highly anisotropic
# by the intramural rotation of the fiber. This rotational anisotropy is
# especially important because it can produce a twist of electrical vortices,
# which measures the rate of rotation (in degree/mm) of activation wavefronts in
# successive planes perpendicular to a line of phase singularity, or filament.
# This twist can then significantly alter the dynamics of the filament. This
# paper explores this dynamics via numerical simulation. After a review of the
# literature, we present modeling tools that include: (i) a simplified ionic
# model with three membrane currents that approximates well the restitution
# properties and spiral wave behavior of more complex ionic models of cardiac
# action potential (Beeler-Reuter and others), and (ii) a semi-implicit algorithm
# for the fast solution of monodomain cable equations with rotational anisotropy.
# We then discuss selected results of a simulation study of vortex dynamics in a
# parallelepipedal slab of ventricular muscle of varying wall thickness (S) and
# fiber rotation rate (theta(z)). The main finding is that rotational anisotropy
# generates a sufficiently large twist to destabilize a single transmural
# filament and cause a transition to a wave turbulent state characterized by a
# high density of chaotically moving filaments. This instability is manifested by
# the propagation of localized disturbances along the filament and has no
# previously known analog in isotropic excitable media. These disturbances
# correspond to highly twisted and distorted regions of filament, or "twistons,"
# that create vortex rings when colliding with the natural boundaries of the
# ventricle. Moreover, when sufficiently twisted, these rings expand and create
# additional filaments by further colliding with boundaries. This instability
# mechanism is distinct from the commonly invoked patchy failure or wave breakup
# that is not observed here during the initial instability. For modified
# Beeler-Reuter-like kinetics with stable reentry in two dimensions, decay into
# turbulence occurs in the left ventricle in about one second above a critical
# wall thickness in the range of 4-6 mm that matches experiment. However this
# decay is suppressed by uniformly decreasing excitability. Specific experiments
# to test these results, and a method to characterize the filament density during
# fibrillation are discussed. Results are contrasted with other mechanisms of
# fibrillation and future prospects are summarized.
# 
# The original paper reference is cited below:
# 
# Vortex dynamics in three-dimensional continuous myocardium with fiber rotation:
# Filament instability and fibrillation, Flavio Fenton and Alain Karma,
# 1998,Chaos,8, 20-47.PubMed ID: 12779708
# 

# gotran file generated by cellml2gotran from fenton_karma_1998_BR.cellml

parameters("p",
           u_c = 0.13)

parameters("q",
           u_v = 0)

parameters("Fast inward current",
           g_fi_max = ScalarParam(5.8, unit="mS*cm**-2"))

states("Fast inward current", "v gate",
       v = 1)

parameters("Fast inward current", "v gate",
           tau_v1_minus = ScalarParam(18.2, unit="ms"),
           tau_v2_minus = ScalarParam(18.2, unit="ms"),
           tau_v_plus = ScalarParam(10, unit="ms"))

parameters("Slow outward current",
           tau_0 = ScalarParam(12.5, unit="ms"),
           tau_r = ScalarParam(130, unit="ms"))

parameters("Slow inward current",
           tau_si = ScalarParam(127, unit="ms"),
           u_csi = 0.85,
           k = 10)

states("Slow inward current", "w gate",
       w = 1)

parameters("Slow inward current", "w gate",
           tau_w_minus = ScalarParam(80, unit="ms"),
           tau_w_plus = ScalarParam(1020, unit="ms"))

parameters("Stimulus protocol",
           IstimStart = ScalarParam(10, unit="ms"),
           IstimEnd = ScalarParam(50000, unit="ms"),
           IstimAmplitude = ScalarParam(-0.2, unit="ms**-1"),
           IstimPeriod = ScalarParam(1000, unit="ms"),
           IstimPulseDuration = ScalarParam(1, unit="ms"))

states("Membrane",
       V =ScalarParam(-85, unit="mV" ))

parameters("Membrane",
           Cm = ScalarParam(1, unit="uF*cm**-2"),
           V_0 = ScalarParam(-85, unit="mV"),
           V_fi = ScalarParam(15, unit="mV"))





expressions("p")
p = Conditional(Lt((V-V_0)/(V_fi - V_0), u_c), 0, 1)

expressions("q")
q = Conditional(Lt((V-V_0)/(V_fi - V_0), u_v), 0, 1)

expressions("Fast inward current")
tau_d = Cm/g_fi_max # ms
J_fi = -v*p*(1 - (V-V_0)/(V_fi - V_0))*((V-V_0)/(V_fi - V_0) - u_c)/tau_d # ms**-1

expressions("Fast inward current", "v gate")
tau_v_minus = q*tau_v1_minus + (1 - q)*tau_v2_minus # ms
dv_dt = (1 - p)*(1 - v)/tau_v_minus - p*v/tau_v_plus

expressions("Slow outward current")
J_so = (V-V_0)/(V_fi - V_0)*(1 - p)/tau_0 + p/tau_r # ms**-1

expressions("Slow inward current")
J_si = -w*(1 + tanh(k*((V-V_0)/(V_fi - V_0) - u_csi)))/(2*tau_si) # ms**-1

expressions("Slow inward current", "w gate")
dw_dt = (1 - p)*(1 - w)/tau_w_minus - p*w/tau_w_plus

expressions("Stimulus protocol")
cond1=And(Ge(time, IstimStart), Le(time, IstimEnd))
#cond2=And(Le(time - IstimStart - floor((time - IstimStart)/IstimPeriod)*IstimPeriod, IstimPulseDuration))			       
#J_stim = Conditional(And(cond1, cond2, ), IstimAmplitude, 0) # ms**-1
J_stim=0

expressions("Membrane")
dV_dt =-(V_fi - V_0)*(J_fi + J_so + J_si + J_stim)
